name: PR Maintenance and Cleanup

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Close stale PRs
  stale-pr-cleanup:
    name: Close Stale PRs
    runs-on: ubuntu-latest
    steps:
      - name: Close stale PRs
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-pr-message: |
            ðŸ‘‹ This PR has been automatically marked as stale because it has not had recent activity.
            It will be closed in 7 days if no further activity occurs.

            If you believe this PR should remain open, please:
            - Add a comment explaining why
            - Update the PR with new changes
            - Request a review

            Thank you for your contributions! ðŸ™
          close-pr-message: |
            ðŸ”’ This PR has been automatically closed due to inactivity.

            If you'd like to continue working on this, please:
            - Rebase your branch on the latest main
            - Open a new PR

            Thank you for your contributions! ðŸ™
          days-before-stale: 30
          days-before-close: 7
          stale-pr-label: 'stale'
          exempt-pr-labels: 'keep-open,in-progress,blocked'
          operations-per-run: 30

  # Check for draft PRs that are ready
  check-draft-prs:
    name: Check Draft PRs
    runs-on: ubuntu-latest
    steps:
      - name: Find old draft PRs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const draftPRs = pullRequests.filter(pr => pr.draft);
            const now = new Date();

            for (const pr of draftPRs) {
              const createdAt = new Date(pr.created_at);
              const daysSinceCreation = (now - createdAt) / (1000 * 60 * 60 * 24);

              // Notify on draft PRs older than 14 days
              if (daysSinceCreation > 14) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `ðŸ‘‹ Hi @${pr.user.login}! This draft PR has been open for ${Math.floor(daysSinceCreation)} days.\n\nIf you're ready to move forward:\n- Mark it as "Ready for review"\n- Request reviewers\n\nIf you're no longer working on this, consider closing it.\n\nThanks! ðŸ™`
                });

                console.log(`Notified PR #${pr.number} about draft status`);
              }
            }

  # Update PR descriptions with checklist status
  update-pr-status:
    name: Update PR Status
    runs-on: ubuntu-latest
    steps:
      - name: Update PR progress
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            for (const pr of pullRequests) {
              if (!pr.body) continue;

              // Count checklist items
              const totalItems = (pr.body.match(/- \[[ x]\]/g) || []).length;
              const completedItems = (pr.body.match(/- \[x\]/g) || []).length;

              if (totalItems > 0) {
                const progress = Math.round((completedItems / totalItems) * 100);
                console.log(`PR #${pr.number}: ${completedItems}/${totalItems} tasks complete (${progress}%)`);

                // Add progress label
                let progressLabel = '';
                if (progress === 100) {
                  progressLabel = 'ready-for-review';
                } else if (progress >= 75) {
                  progressLabel = 'almost-done';
                } else if (progress >= 25) {
                  progressLabel = 'in-progress';
                } else {
                  progressLabel = 'just-started';
                }

                // Add the label
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    labels: [progressLabel]
                  });
                } catch (error) {
                  // Label might already exist
                }
              }
            }

  # Check for merge-ready PRs
  check-merge-ready:
    name: Check Merge Ready PRs
    runs-on: ubuntu-latest
    steps:
      - name: Find merge-ready PRs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            for (const pr of pullRequests) {
              // Skip draft PRs
              if (pr.draft) continue;

              // Get PR details
              const { data: prDetails } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              // Check if PR is ready to merge
              const isApproved = prDetails.mergeable && prDetails.mergeable_state === 'clean';
              const hasConflicts = prDetails.mergeable === false;

              if (hasConflicts) {
                // Check if conflict label exists
                const hasConflictLabel = pr.labels.some(label => label.name === 'conflict');
                if (!hasConflictLabel) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    labels: ['conflict']
                  });
                  console.log(`Added conflict label to PR #${pr.number}`);
                }
              } else if (isApproved) {
                // Check if ready-to-merge label exists
                const hasReadyLabel = pr.labels.some(label => label.name === 'ready-to-merge');
                if (!hasReadyLabel) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    labels: ['ready-to-merge']
                  });
                  console.log(`Added ready-to-merge label to PR #${pr.number}`);
                }
              }
            }
