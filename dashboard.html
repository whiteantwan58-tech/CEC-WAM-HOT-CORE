<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÆ CEC-WAM Dashboard | SOVEREIGN SYSTEM</title>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        :root {
            --bg: #04060a;
            --bg-panel: rgba(10, 15, 25, 0.9);
            --ink: #a9f7ff;
            --neon: #28f0ff;
            --neon2: #2cff9a;
            --vio: #bc13fe;
            --warn: #ffd166;
            --bad: #ff4d6d;
            --good: #00ff88;
            --gold: #ffd700;
            --border: rgba(40, 240, 255, 0.3);
            --shadow: 0 0 20px rgba(40, 240, 255, 0.3);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Orbitron', monospace;
            background: var(--bg);
            color: var(--ink);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1A0040 0%, #0A0020 50%, #000010 100%);
            z-index: -2;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(40, 240, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(40, 240, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridScroll 20s linear infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes gridScroll {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        /* Header */
        header {
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid var(--vio);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(188, 19, 254, 0.4);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        h1 {
            font-size: 1.8rem;
            color: var(--neon);
            text-shadow: 0 0 20px rgba(40, 240, 255, 0.8);
            letter-spacing: 0.1em;
        }
        
        .status-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-pill {
            padding: 0.5rem 1rem;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--good);
            box-shadow: 0 0 10px var(--good);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .refresh-btn {
            padding: 0.6rem 1.5rem;
            background: linear-gradient(90deg, var(--neon) 0%, var(--neon2) 100%);
            border: none;
            border-radius: 25px;
            color: #000;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(40, 240, 255, 0.5);
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(40, 240, 255, 0.7);
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Cards */
        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 30px rgba(40, 240, 255, 0.5);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card h2 {
            font-size: 1.2rem;
            color: var(--neon2);
            text-shadow: 0 0 10px rgba(44, 255, 154, 0.6);
        }
        
        .card-icon {
            font-size: 1.5rem;
        }
        
        /* Metrics */
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(40, 240, 255, 0.1);
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--ink);
            font-size: 0.9rem;
        }
        
        .metric-value {
            color: var(--good);
            font-weight: bold;
            font-size: 1rem;
        }
        
        .metric-value.large {
            font-size: 2rem;
            text-shadow: 0 0 10px var(--good);
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        th {
            background: rgba(40, 240, 255, 0.15);
            padding: 0.8rem;
            text-align: left;
            color: var(--neon);
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }
        
        td {
            padding: 0.8rem;
            border: 1px solid rgba(40, 240, 255, 0.1);
            font-size: 0.85rem;
        }
        
        tr:nth-child(even) {
            background: rgba(40, 240, 255, 0.05);
        }
        
        tr:hover {
            background: rgba(40, 240, 255, 0.1);
        }
        
        /* Task Status Colors */
        .status-high {
            color: var(--bad);
            font-weight: bold;
        }
        
        .status-medium {
            color: var(--warn);
            font-weight: bold;
        }
        
        .status-low {
            color: var(--good);
            font-weight: bold;
        }
        
        .status-in-progress {
            color: var(--neon);
        }
        
        .status-pending {
            color: var(--warn);
        }
        
        .status-completed {
            color: var(--good);
        }
        
        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(40, 240, 255, 0.3);
            border-top-color: var(--neon);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            color: var(--bad);
            padding: 1rem;
            background: rgba(255, 77, 109, 0.1);
            border: 1px solid var(--bad);
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        /* Full width card */
        .card-full {
            grid-column: 1 / -1;
        }
        
        /* Export Button */
        .export-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-panel);
            border: 1px solid var(--neon2);
            border-radius: 5px;
            color: var(--neon2);
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .export-btn:hover {
            background: rgba(44, 255, 154, 0.2);
            box-shadow: 0 0 15px rgba(44, 255, 154, 0.5);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.3rem;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üîÆ CEC-WAM DASHBOARD | SOVEREIGN SYSTEM</h1>
            <div class="status-bar">
                <div class="status-pill">
                    <div class="status-dot"></div>
                    <span>SYSTEM ONLINE</span>
                </div>
                <div class="status-pill">
                    <span>Last Sync: <span id="lastSync">--:--:--</span></span>
                </div>
                <button class="refresh-btn" onclick="refreshAllData()">
                    <span id="refreshText">üîÑ REFRESH DATA</span>
                </button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Financial KPIs -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2>üí∞ PSI-COIN BALANCE</h2>
                    <span class="card-icon">Œ®</span>
                </div>
                <div class="metric-value large" id="psiBalance">Loading...</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>üíµ LIQUIDITY RESERVES</h2>
                    <span class="card-icon">üíé</span>
                </div>
                <div class="metric-value large" id="liquidityReserves">Loading...</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>üìä NET WORTH</h2>
                    <span class="card-icon">üåü</span>
                </div>
                <div class="metric-value large" id="netWorth">Loading...</div>
            </div>
        </div>
        
        <!-- Asset Metrics -->
        <div class="card card-full">
            <div class="card-header">
                <h2>üè¶ CEC MATRIX SYSTEM ASSETS</h2>
                <button class="export-btn" onclick="exportData('assets')">üíæ EXPORT CSV</button>
            </div>
            <div id="assetsTable">Loading assets...</div>
        </div>
        
        <!-- PSI Price Chart -->
        <div class="card card-full">
            <div class="card-header">
                <h2>üìà PSI PRICE TRACKER (TridentDAO)</h2>
                <div id="psiPriceInfo" style="font-size: 0.9rem; color: var(--ink);"></div>
            </div>
            <div class="chart-container">
                <canvas id="psiPriceChart"></canvas>
            </div>
        </div>
        
        <!-- Tasks -->
        <div class="card card-full">
            <div class="card-header">
                <h2>‚úÖ EVE TASK MANAGEMENT</h2>
                <button class="export-btn" onclick="exportData('tasks')">üíæ EXPORT CSV</button>
            </div>
            <div id="tasksTable">Loading tasks...</div>
        </div>
        
        <!-- Google Sheets Data -->
        <div class="card card-full">
            <div class="card-header">
                <h2>üìã GOOGLE SHEETS LIVE DATA</h2>
                <button class="export-btn" onclick="exportData('sheets')">üíæ EXPORT CSV</button>
            </div>
            <div id="sheetsTable">Loading Google Sheets data...</div>
            <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--ink); opacity: 0.7;">
                <span>Data Points: <span id="dataPoints">0</span></span> | 
                <span>Load Time: <span id="loadTime">--</span></span>
            </div>
        </div>
        
        <!-- NASA APOD -->
        <div class="card card-full">
            <div class="card-header">
                <h2>üåå NASA ASTRONOMY PICTURE OF THE DAY</h2>
            </div>
            <div id="nasaApod">Loading NASA APOD...</div>
        </div>
    </div>
    
    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_SHEETS_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vREgUUHPCzTBWK8i1PWBrE2E4pKRTAgaReJahFqmrTetCZyCO0QHVlAleodUsTlJv_86KpzH_NPv9dv/pub?output=csv',
            // NASA API Key: DEMO_KEY has rate limits (30 requests/hour, 50 requests/day)
            // For production use, get your own free API key from https://api.nasa.gov/
            NASA_API_KEY: 'DEMO_KEY',
            COINGECKO_API: 'https://api.coingecko.com/api/v3/simple/price?ids=tridentdao&vs_currencies=usd&include_24h_change=true',
            REFRESH_INTERVAL: 60000, // 1 minute
            ASSETS_CSV: 'data/CEC_Matrix_System_Operational_Metrics_and_Assets.csv',
            TASKS_CSV: 'data/EVE_UNFINISHED_TASKS.csv'
        };
        
        // Global data storage
        let assetsData = [];
        let tasksData = [];
        let sheetsData = [];
        let psiPriceHistory = [];
        let psiPriceChart = null;
        let autoRefreshTimer = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîÆ Initializing CEC-WAM Dashboard...');
            refreshAllData();
            startAutoRefresh();
        });
        
        // Auto-refresh
        function startAutoRefresh() {
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(() => {
                if (!document.hidden) {
                    refreshAllData();
                }
            }, CONFIG.REFRESH_INTERVAL);
        }
        
        // Main refresh function
        async function refreshAllData() {
            updateTimestamp();
            
            const refreshBtn = document.getElementById('refreshText');
            refreshBtn.innerHTML = '<span class="loading"></span> SYNCING...';
            
            try {
                await Promise.all([
                    loadAssetsData(),
                    loadTasksData(),
                    loadGoogleSheetsData(),
                    loadPSIPrice(),
                    loadNASAApod()
                ]);
                
                refreshBtn.textContent = '‚úì DATA SYNCED';
                setTimeout(() => {
                    refreshBtn.textContent = 'üîÑ REFRESH DATA';
                }, 2000);
            } catch (error) {
                console.error('Error refreshing data:', error);
                refreshBtn.textContent = '‚ùå SYNC ERROR';
                setTimeout(() => {
                    refreshBtn.textContent = 'üîÑ REFRESH DATA';
                }, 3000);
            }
        }
        
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastSync').textContent = now.toLocaleTimeString();
        }
        
        // Load Assets Data
        async function loadAssetsData() {
            try {
                const response = await fetch(CONFIG.ASSETS_CSV);
                const csvText = await response.text();
                const data = parseCSV(csvText);
                assetsData = data;
                
                // Calculate financial KPIs
                let psiBalance = 0;
                let liquidityReserves = 0;
                let netWorth = 0;
                
                data.forEach(row => {
                    const assetClass = row['A (ASSET CLASS)'] || '';
                    const value = row['D (VALUE)'] || '0';
                    const numValue = parseFloat(value.replace(/[$,]/g, ''));
                    
                    if (!isNaN(numValue)) {
                        netWorth += numValue;
                        
                        if (assetClass.toLowerCase().includes('psi-coin')) {
                            psiBalance = numValue;
                        } else if (assetClass.toLowerCase().includes('escrow') || 
                                   assetClass.toLowerCase().includes('bridge')) {
                            liquidityReserves += numValue;
                        }
                    }
                });
                
                // Update UI
                document.getElementById('psiBalance').textContent = `$${psiBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                document.getElementById('liquidityReserves').textContent = `$${liquidityReserves.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                document.getElementById('netWorth').textContent = `$${netWorth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                // Display table
                displayTable('assetsTable', data, ['A (ASSET CLASS)', 'B (LOCATION)', 'C (SECURITY PROTOCOL)', 'D (VALUE)']);
                
            } catch (error) {
                console.error('Error loading assets:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = `Failed to load assets data: ${error.message}. Please ensure the file exists at data/CEC_Matrix_System_Operational_Metrics_and_Assets.csv and the server is running.`;
                document.getElementById('assetsTable').innerHTML = '';
                document.getElementById('assetsTable').appendChild(errorDiv);
            }
        }
        
        // Load Tasks Data
        async function loadTasksData() {
            try {
                const response = await fetch(CONFIG.TASKS_CSV);
                const csvText = await response.text();
                const data = parseCSV(csvText);
                tasksData = data;
                
                displayTasksTable(data);
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = `Failed to load tasks data: ${error.message}. Please ensure the file exists at data/EVE_UNFINISHED_TASKS.csv and the server is running.`;
                document.getElementById('tasksTable').innerHTML = '';
                document.getElementById('tasksTable').appendChild(errorDiv);
            }
        }
        
        // Load Google Sheets Data
        async function loadGoogleSheetsData() {
            const loadStart = Date.now();
            try {
                const response = await fetch(CONFIG.GOOGLE_SHEETS_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const csvText = await response.text();
                const data = parseCSV(csvText);
                sheetsData = data;
                
                const loadTime = ((Date.now() - loadStart) / 1000).toFixed(2);
                document.getElementById('loadTime').textContent = `${loadTime}s`;
                document.getElementById('dataPoints').textContent = data.length;
                
                // Get headers
                const headers = data.length > 0 ? Object.keys(data[0]) : [];
                displayTable('sheetsTable', data, headers);
                
            } catch (error) {
                console.error('Error loading Google Sheets:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = `Failed to load Google Sheets data: ${error.message}. Please check your internet connection and ensure the Google Sheets URL is publicly accessible.`;
                document.getElementById('sheetsTable').innerHTML = '';
                document.getElementById('sheetsTable').appendChild(errorDiv);
            }
        }
        
        // Load PSI Price
        async function loadPSIPrice() {
            try {
                const response = await fetch(CONFIG.COINGECKO_API);
                const data = await response.json();
                
                const price = data.tridentdao?.usd || 0;
                const change = data.tridentdao?.usd_24h_change || 0;
                
                // Update price info
                const changeColor = change >= 0 ? 'var(--good)' : 'var(--bad)';
                const changeSymbol = change >= 0 ? '+' : '';
                document.getElementById('psiPriceInfo').innerHTML = `
                    Current Price: <strong style="color: var(--neon2)">$${price.toFixed(6)}</strong> | 
                    24h Change: <strong style="color: ${changeColor}">${changeSymbol}${change.toFixed(2)}%</strong>
                `;
                
                // Add to history
                psiPriceHistory.push({
                    time: new Date().toLocaleTimeString(),
                    price: price
                });
                
                // Keep last 20 points
                if (psiPriceHistory.length > 20) {
                    psiPriceHistory.shift();
                }
                
                updatePSIChart();
                
            } catch (error) {
                console.error('Error loading PSI price:', error);
                document.getElementById('psiPriceInfo').innerHTML = `<span style="color: var(--bad)">Price data unavailable</span>`;
            }
        }
        
        // Load NASA APOD
        async function loadNASAApod() {
            try {
                const url = `https://api.nasa.gov/planetary/apod?api_key=${CONFIG.NASA_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                // Create elements safely to prevent XSS
                const container = document.createElement('div');
                container.style.cssText = 'display: flex; flex-direction: column; gap: 1rem;';
                
                const title = document.createElement('h3');
                title.style.color = 'var(--neon2)';
                title.textContent = data.title || 'No title';
                container.appendChild(title);
                
                const explanation = document.createElement('p');
                explanation.style.cssText = 'font-size: 0.9rem; color: var(--ink);';
                explanation.textContent = data.explanation || 'No description available';
                container.appendChild(explanation);
                
                if (data.url) {
                    const link = document.createElement('a');
                    link.setAttribute('href', data.url);
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');
                    link.style.cssText = 'color: var(--neon); text-decoration: none;';
                    
                    const img = document.createElement('img');
                    img.setAttribute('src', data.url);
                    img.setAttribute('alt', data.title || 'NASA APOD');
                    img.style.cssText = 'max-width: 100%; border-radius: 10px; box-shadow: var(--shadow);';
                    
                    link.appendChild(img);
                    container.appendChild(link);
                }
                
                const date = document.createElement('p');
                date.style.cssText = 'font-size: 0.85rem; opacity: 0.7;';
                date.textContent = `Date: ${data.date || 'Unknown'}`;
                container.appendChild(date);
                
                document.getElementById('nasaApod').innerHTML = '';
                document.getElementById('nasaApod').appendChild(container);
                
            } catch (error) {
                console.error('Error loading NASA APOD:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = `Failed to load NASA APOD: ${error.message}. This may be due to API rate limits or network issues.`;
                document.getElementById('nasaApod').innerHTML = '';
                document.getElementById('nasaApod').appendChild(errorDiv);
            }
        }
        
        // Update PSI Chart
        function updatePSIChart() {
            const ctx = document.getElementById('psiPriceChart');
            if (!ctx) return;
            
            const labels = psiPriceHistory.map(p => p.time);
            const prices = psiPriceHistory.map(p => p.price);
            
            if (psiPriceChart) {
                psiPriceChart.data.labels = labels;
                psiPriceChart.data.datasets[0].data = prices;
                psiPriceChart.update();
            } else {
                psiPriceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'PSI Price (USD)',
                            data: prices,
                            borderColor: 'rgba(40, 240, 255, 1)',
                            backgroundColor: 'rgba(40, 240, 255, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#a9f7ff',
                                    font: {
                                        family: 'Orbitron'
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#a9f7ff',
                                    font: {
                                        family: 'Orbitron'
                                    }
                                },
                                grid: {
                                    color: 'rgba(40, 240, 255, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#a9f7ff',
                                    font: {
                                        family: 'Orbitron'
                                    },
                                    callback: function(value) {
                                        return '$' + value.toFixed(6);
                                    }
                                },
                                grid: {
                                    color: 'rgba(40, 240, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Display generic table
        function displayTable(elementId, data, headers) {
            if (!data || data.length === 0) {
                document.getElementById(elementId).innerHTML = '<p style="opacity: 0.7;">No data available</p>';
                return;
            }
            
            const table = document.createElement('table');
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            document.getElementById(elementId).innerHTML = '';
            document.getElementById(elementId).appendChild(table);
        }
        
        // Display tasks table with status styling
        function displayTasksTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('tasksTable').innerHTML = '<p style="opacity: 0.7;">No tasks available</p>';
                return;
            }
            
            const table = document.createElement('table');
            const headers = ['Task_ID', 'Task_Name', 'Priority', 'Status', 'Assigned_To', 'Due_Date', 'Category'];
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.replace(/_/g, ' ');
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    const value = row[header] || '';
                    td.textContent = value;
                    
                    // Apply status styling
                    if (header === 'Priority') {
                        if (value.toLowerCase() === 'high') td.className = 'status-high';
                        else if (value.toLowerCase() === 'medium') td.className = 'status-medium';
                        else if (value.toLowerCase() === 'low') td.className = 'status-low';
                    } else if (header === 'Status') {
                        if (value.toLowerCase().includes('progress')) td.className = 'status-in-progress';
                        else if (value.toLowerCase().includes('pending')) td.className = 'status-pending';
                        else if (value.toLowerCase().includes('completed')) td.className = 'status-completed';
                    }
                    
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            document.getElementById('tasksTable').innerHTML = '';
            document.getElementById('tasksTable').appendChild(table);
        }
        
        // CSV Parser - handles quotes and commas properly
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length > 0) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }
        
        // Parse a single CSV line
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // Export data to CSV
        function exportData(type) {
            let data, filename;
            
            switch(type) {
                case 'assets':
                    data = assetsData;
                    filename = 'CEC_Assets_Export.csv';
                    break;
                case 'tasks':
                    data = tasksData;
                    filename = 'EVE_Tasks_Export.csv';
                    break;
                case 'sheets':
                    data = sheetsData;
                    filename = 'GoogleSheets_Export.csv';
                    break;
                default:
                    return;
            }
            
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Convert to CSV with proper escaping
            const headers = Object.keys(data[0]);
            
            // Escape headers properly
            const escapedHeaders = headers.map(header => {
                if (header.includes(',') || header.includes('"') || header.includes('\n')) {
                    return '"' + header.replace(/"/g, '""') + '"';
                }
                return header;
            });
            
            let csv = escapedHeaders.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] || '';
                    // Escape CSV special characters (RFC 4180)
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csv += values.join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Pause auto-refresh when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Dashboard hidden - pausing auto-refresh');
            } else {
                console.log('Dashboard visible - resuming auto-refresh');
                refreshAllData();
            }
        });
        
        console.log('üîÆ CEC-WAM Dashboard loaded successfully');
    </script>
</body>
</html>
