<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CEC-WAM LIVE — EVE HEI</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- localForage for IndexedDB storage -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#050505" />

  <style>
    body { background: #050505; color: #e6eef6; font-family: Inter, Rajdhani, sans-serif; }
    .glass { background: rgba(10, 10, 12, 0.7); border: 1px solid rgba(255,255,255,0.04); }
    .small { font-size: 0.85rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <header class="p-4 border-b border-gray-800 flex justify-between items-center">
    <div>
      <h1 class="text-xl font-bold">CEC-WAM LIVE — EVE HEI</h1>
      <div class="text-xs text-gray-400">System V.47.0 — Live Neural Link</div>
    </div>

    <div class="flex items-center gap-3">
      <button id="install-btn" class="bg-cyan-600 px-3 py-1 rounded text-black hidden">Install</button>
      <button id="open-vault" class="bg-gray-800 px-3 py-1 rounded text-green-400 small">Vault</button>
    </div>
  </header>

  <main class="flex-1 p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Left: Controls -->
    <section class="col-span-1 glass p-4 rounded space-y-3">
      <h2 class="font-semibold">Data Connection</h2>

      <label class="small">Google Sheet (Publish -> CSV) URL</label>
      <input id="sheet-url" class="w-full bg-black/60 p-2 rounded mono text-sm" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv" />

      <div class="flex gap-2">
        <button id="link-sheet" class="bg-green-600 px-3 py-2 rounded font-bold">Link</button>
        <button id="unlink-sheet" class="bg-gray-700 px-3 py-2 rounded">Unlink</button>
        <button id="fetch-now" class="bg-cyan-600 px-3 py-2 rounded">Fetch Now</button>
      </div>

      <hr />

      <h3 class="font-semibold">Import / Export</h3>
      <input id="file-input" type="file" accept=".csv,.xlsx,.xls" class="text-xs" />
      <div class="flex gap-2 mt-2">
        <button id="import-btn" class="bg-blue-600 px-3 py-2 rounded">Import</button>
        <button id="export-btn" class="bg-yellow-600 px-3 py-2 rounded">Export Logs</button>
      </div>

      <hr />

      <h3 class="font-semibold">EVE HEI Voice</h3>
      <div class="flex gap-2">
        <button id="start-mic" class="bg-purple-600 px-3 py-2 rounded">Talk (Mic)</button>
        <button id="speak-sample" class="bg-gray-700 px-3 py-2 rounded">Speak</button>
      </div>

      <hr />

      <h3 class="font-semibold">Local PIN (device only)</h3>
      <div class="flex gap-2">
        <input id="pin-input" type="password" placeholder="Set or Enter PIN" class="bg-black/60 p-2 rounded mono" />
        <button id="set-pin" class="bg-red-600 px-3 py-2 rounded">Set PIN</button>
      </div>

      <div id="status" class="text-xs text-gray-400 mt-2 mono"></div>
    </section>

    <!-- Middle: Charts -->
    <section class="col-span-1 md:col-span-2 glass p-4 rounded space-y-4">
      <div class="flex justify-between items-start">
        <h2 class="font-semibold">Dashboard — Charts & Data</h2>
        <div class="text-xs text-gray-400 mono" id="last-sync">Last sync: never</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-3 bg-black/60 rounded">
          <canvas id="kpichart" height="160"></canvas>
        </div>

        <div class="p-3 bg-black/60 rounded">
          <canvas id="serieschart" height="160"></canvas>
        </div>
      </div>

      <div class="mt-4 p-2 bg-black/60 rounded">
        <h3 class="font-semibold">Log</h3>
        <div id="log-box" class="h-48 overflow-auto bg-black/30 p-2 rounded mono text-xs text-gray-300"></div>
      </div>
    </section>
  </main>

  <footer class="p-3 text-xs text-gray-400 text-center">
    Tip: Publish your master Google Sheet (File → Publish to web → CSV) and paste the CSV URL above. To run without Wi‑Fi, copy this folder to a flash drive and run a local static server.
  </footer>

  <script src="app.js"></script>

  <!-- PWA register -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').then(()=>console.log('SW registered'));
    }

    // Install prompt forwarding
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install-btn').classList.remove('hidden');
      document.getElementById('install-btn').onclick = async () => {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        console.log('A2HS result', choice);
      };
    });
  </script>
</body>
</html>
