import React, { useState, useEffect, useRef } from 'react';
import { 
  LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, AreaChart, Area 
} from 'recharts';
import { 
  Zap, Activity, Shield, Layers, Globe, Cpu, RefreshCw, AlertTriangle, Compass, Target, Sparkles, MessageSquare, Send, FileText, Loader2, Maximize2
} from 'lucide-react';

// --- CONFIGURATION ---
const PSI_CONTRACT = "YOUR_SOLANA_PSI_CONTRACT_HERE"; 
const INITIAL_PRICE = 0.003077; 
const UPDATE_INTERVAL = 2000; 
const apiKey = ""; // Environment provided

// Dynamic Particle Star Map Component (Full Screen optimized)
const StarField = ({ intensity }) => {
  const canvasRef = useRef(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    let animationFrameId;
    
    const particles = [];
    const particleCount = 200;

    const resize = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    };

    window.addEventListener('resize', resize);
    resize();

    class Particle {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.z = Math.random() * canvas.width;
        this.size = 0.5 + Math.random() * 2;
        this.speed = (0.5 + Math.random() * 2) * intensity;
      }
      update() {
        this.z -= this.speed;
        if (this.z <= 0) this.reset();
      }
      draw() {
        const x = (this.x - canvas.width / 2) * (canvas.width / this.z) + canvas.width / 2;
        const y = (this.y - canvas.height / 2) * (canvas.width / this.z) + canvas.height / 2;
        const s = this.size * (canvas.width / this.z);
        const opacity = Math.min(1.5 - this.z / canvas.width, 1);
        
        ctx.beginPath();
        ctx.arc(x, y, s, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(34, 211, 238, ${opacity * 0.5})`;
        ctx.fill();
      }
    }

    for (let i = 0; i < particleCount; i++) particles.push(new Particle());

    const render = () => {
      ctx.fillStyle = 'rgba(5, 5, 5, 0.2)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.update();
        p.draw();
      });
      animationFrameId = requestAnimationFrame(render);
    };

    render();
    return () => {
      cancelAnimationFrame(animationFrameId);
      window.removeEventListener('resize', resize);
    };
  }, [intensity]);

  return <canvas ref={canvasRef} className="fixed inset-0 z-0 pointer-events-none" />;
};

const App = () => {
  const [price, setPrice] = useState(INITIAL_PRICE);
  const [history, setHistory] = useState([]);
  const [change24h, setChange24h] = useState(12.8);
  const [entropy, setEntropy] = useState(0.42);
  const [intensity, setIntensity] = useState(1.0);
  
  // Gemini State
  const [chatInput, setChatInput] = useState("");
  const [chatLog, setChatLog] = useState([{ role: 'ai', text: "Chronos AI online. Full-screen telemetry engaged. Standby for PSI analysis." }]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [report, setReport] = useState("");
  const [showReportModal, setShowReportModal] = useState(false);

  useEffect(() => {
    const interval = setInterval(() => {
      const volatility = (Math.random() - 0.45) * 0.00015;
      setPrice(prev => {
        const next = prev + volatility;
        const newPoint = {
          time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
          val: next
        };
        setHistory(prevHist => [...prevHist.slice(-40), newPoint]);
        return next;
      });
      
      const newEntropy = Math.random();
      setEntropy(newEntropy.toFixed(2));
      setIntensity(1.0 + newEntropy * 2);
    }, UPDATE_INTERVAL);

    return () => clearInterval(interval);
  }, []);

  const callGemini = async (prompt, systemPrompt = "") => {
    let retries = 0;
    const maxRetries = 5;
    
    while (retries < maxRetries) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined
          })
        });
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "Communication error with Chronos Node.";
      } catch (err) {
        retries++;
        await new Promise(r => setTimeout(r, Math.pow(2, retries) * 1000));
      }
    }
    return "Maximum retries exceeded. Terminal offline.";
  };

  const handleChat = async () => {
    if (!chatInput.trim()) return;
    const userMsg = { role: 'user', text: chatInput };
    setChatLog(prev => [...prev, userMsg]);
    setChatInput("");
    setIsGenerating(true);

    const systemPrompt = "You are Chronos AI, a highly advanced 5D market analyst for the PSI Coin on Solana. Your tone is technical, futuristic, and focused on 'Entropy' and 'World Asset Management'. Keep responses concise and insightful.";
    const prompt = `User Query: ${chatInput}\n\nCurrent Market Data:\nPrice: $${price.toFixed(6)}\nEntropy: ${entropy}\nTrend: ${change24h}% 24h`;
    
    const result = await callGemini(prompt, systemPrompt);
    setChatLog(prev => [...prev, { role: 'ai', text: result }]);
    setIsGenerating(false);
  };

  const generateSignalReport = async () => {
    setIsGenerating(true);
    const prompt = `Generate a detailed market signal report for PSI Coin. 
    Current Price: $${price.toFixed(6)}
    System Entropy: ${entropy}
    24h Change: ${change24h}%
    Context: CEC-WAM World Asset Management.
    Structure the report with: Market Sentiment, Risk Vector, and Tactical Recommendation. Use futuristic professional language.`;
    
    const result = await callGemini(prompt, "You are a professional CEC-WAM intelligence officer.");
    setReport(result);
    setShowReportModal(true);
    setIsGenerating(false);
  };

  return (
    <div className="w-screen h-screen bg-[#050505] text-white font-sans p-0 m-0 overflow-hidden relative selection:bg-cyan-500/30">
      <StarField intensity={intensity} />
      
      {/* Dynamic Background Overlays */}
      <div className="fixed top-[-20%] left-[-10%] w-[60%] h-[60%] bg-cyan-900/10 rounded-full blur-[180px] animate-pulse"></div>
      <div className="fixed bottom-[-20%] right-[-10%] w-[60%] h-[60%] bg-purple-900/10 rounded-full blur-[180px] animate-pulse"></div>

      {/* Main Container: Full Width/Height Grid */}
      <div className="relative z-10 w-full h-full flex flex-col p-4 md:p-6 gap-4">
        
        {/* HEADER: GLOBAL SYSTEM BAR */}
        <header className="flex-none flex justify-between items-center bg-white/5 backdrop-blur-3xl border border-white/10 px-8 py-5 rounded-[2rem] shadow-2xl">
          <div className="flex items-center gap-6">
            <div className="relative group">
              <div className="absolute inset-0 bg-cyan-400 blur-xl opacity-20 group-hover:opacity-50 transition-opacity"></div>
              <div className="w-16 h-16 bg-gradient-to-tr from-cyan-500 to-blue-700 rounded-2xl flex items-center justify-center shadow-lg relative z-10 transition-transform hover:scale-105 active:scale-95">
                <Target className="text-white" size={36} />
              </div>
            </div>
            <div>
              <h1 className="text-4xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-white/40">CEC-WAM // PSI_SYSTEM</h1>
              <div className="flex items-center gap-4 mt-1">
                <span className="text-[10px] bg-cyan-500 text-black px-3 py-1 rounded-full font-black tracking-[0.2em] uppercase italic">✨ QUANTUM_AI_SYNC</span>
                <p className="text-xs text-cyan-400 flex items-center gap-2 font-mono">
                  <Activity size={14} className="animate-pulse" /> GRID_STATUS: OPTIMAL
                </p>
              </div>
            </div>
          </div>

          <div className="flex items-center gap-8">
            <div className="text-right hidden xl:block">
              <div className="text-[10px] text-white/30 uppercase tracking-[0.5em] mb-1">Telemetry Entropy</div>
              <div className="text-2xl font-mono text-cyan-400 font-bold">{entropy}</div>
            </div>
            <button 
              onClick={generateSignalReport}
              disabled={isGenerating}
              className="px-8 py-4 bg-white text-black hover:bg-cyan-400 hover:scale-105 active:scale-95 transition-all font-black rounded-2xl text-sm flex items-center gap-3 shadow-2xl disabled:opacity-50"
            >
              {isGenerating ? <Loader2 size={18} className="animate-spin" /> : <Sparkles size={18} />}
              REPORT_SIGNAL
            </button>
          </div>
        </header>

        {/* MAIN TACTICAL GRID */}
        <main className="flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-12 gap-4">
          
          {/* LEFT: 5D MARKET DEPTH (Takes up more space now) */}
          <section className="lg:col-span-8 bg-white/5 backdrop-blur-[50px] border border-white/10 rounded-[3rem] p-10 flex flex-col justify-between shadow-2xl relative overflow-hidden group">
            {/* HUD Elements */}
            <div className="absolute top-8 left-8 p-1 border-l-2 border-t-2 border-cyan-500/50 w-8 h-8 opacity-40 group-hover:opacity-100 transition-opacity"></div>
            <div className="absolute bottom-8 right-8 p-1 border-r-2 border-b-2 border-cyan-500/50 w-8 h-8 opacity-40 group-hover:opacity-100 transition-opacity"></div>
            
            <div className="relative z-10 flex justify-between items-start">
              <div>
                <div className="text-cyan-400 text-xs font-black uppercase tracking-[0.6em] mb-6 flex items-center gap-2">
                  <div className="w-1.5 h-1.5 bg-cyan-400 rounded-full animate-ping"></div>
                  LIVE_VALUATION_STREAM
                </div>
                <div className="text-8xl xl:text-9xl font-black tracking-tighter text-white tabular-nums drop-shadow-[0_0_30px_rgba(34,211,238,0.2)]">
                  ${price.toFixed(6)}
                </div>
              </div>
              <div className="text-right flex flex-col items-end">
                <span className="text-xs font-bold text-white/30 uppercase tracking-widest mb-1">Delta Sync (24h)</span>
                <span className={`text-4xl font-black ${change24h >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                  {change24h >= 0 ? '+' : ''}{change24h}%
                </span>
                <div className="mt-4 flex gap-1">
                  {[...Array(5)].map((_, i) => <div key={i} className={`w-8 h-1 ${i < 3 ? 'bg-cyan-500' : 'bg-white/10'}`}></div>)}
                </div>
              </div>
            </div>

            {/* Expansive Graph Area */}
            <div className="flex-1 mt-12 relative z-10 group">
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={history}>
                  <defs>
                    <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%" stopColor="#22d3ee" stopOpacity={0.6}/>
                      <stop offset="100%" stopColor="#22d3ee" stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <Tooltip 
                    contentStyle={{ backgroundColor: 'rgba(0,0,0,0.9)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '1rem' }}
                    itemStyle={{ color: '#22d3ee', fontWeight: 'bold' }}
                  />
                  <Area 
                    type="step" 
                    dataKey="val" 
                    stroke="#22d3ee" 
                    strokeWidth={5} 
                    fill="url(#chartGrad)" 
                    isAnimationActive={false} 
                    dot={{ r: 0 }}
                    activeDot={{ r: 8, stroke: '#fff', strokeWidth: 2 }}
                  />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </section>

          {/* RIGHT: CHRONOS AI & PROTOCOLS */}
          <section className="lg:col-span-4 flex flex-col gap-4 min-h-0">
            
            {/* AI TERMINAL */}
            <div className="flex-1 flex flex-col bg-white/5 backdrop-blur-3xl border border-white/10 rounded-[2.5rem] overflow-hidden shadow-2xl">
              <div className="px-6 py-4 border-b border-white/10 flex items-center justify-between bg-white/5">
                <span className="text-[10px] font-black tracking-[0.3em] text-cyan-400 flex items-center gap-3">
                  <MessageSquare size={14} /> CHRONOS_INTEL_NODE
                </span>
                <Maximize2 size={12} className="text-white/20 cursor-pointer hover:text-white" />
              </div>
              
              <div className="flex-1 overflow-y-auto p-6 space-y-4 font-mono text-xs custom-scrollbar">
                {chatLog.map((msg, i) => (
                  <div key={i} className={`${msg.role === 'ai' ? 'text-cyan-300' : 'text-white/50'} leading-relaxed p-3 rounded-xl ${msg.role === 'ai' ? 'bg-cyan-400/5' : 'bg-white/5'}`}>
                    <span className="font-black mr-2 opacity-30">{msg.role === 'ai' ? 'CORE:' : 'USER:'}</span>
                    {msg.text}
                  </div>
                ))}
                {isGenerating && (
                  <div className="flex items-center gap-3 text-cyan-400 font-black animate-pulse">
                    <Loader2 size={14} className="animate-spin" /> RUNNING_RECURSIVE_HEURISTICS...
                  </div>
                )}
                <div id="chat-end"></div>
              </div>

              <div className="p-6 bg-black/60 border-t border-white/10">
                <div className="relative group">
                  <input 
                    type="text" 
                    value={chatInput}
                    onChange={(e) => setChatInput(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleChat()}
                    placeholder="ENTER COMMAND..."
                    className="w-full bg-white/5 border border-white/10 rounded-2xl py-4 pl-5 pr-14 text-sm focus:outline-none focus:border-cyan-500/50 transition-all placeholder:text-white/20 uppercase tracking-widest font-black"
                  />
                  <button 
                    onClick={handleChat}
                    className="absolute right-3 top-3 p-2 bg-cyan-500 text-black rounded-xl hover:bg-cyan-400 transition-all shadow-lg shadow-cyan-500/20 active:scale-90"
                  >
                    <Send size={18} />
                  </button>
                </div>
              </div>
            </div>

            {/* PROTOCOL DATA */}
            <div className="bg-gradient-to-br from-cyan-500/10 to-purple-500/10 p-8 rounded-[2.5rem] border border-white/10 flex justify-between items-center group cursor-pointer hover:border-cyan-400/50 transition-all">
              <div className="flex items-center gap-6">
                <Compass className="text-cyan-400 animate-spin-slow h-12 w-12" />
                <div>
                  <h4 className="text-xl font-black text-white tracking-tight">CEC_NAVIGATION</h4>
                  <p className="text-[10px] text-white/40 uppercase tracking-widest mt-1">Universal Vector Lock Active</p>
                </div>
              </div>
              <div className="h-12 w-12 rounded-full border border-cyan-500/20 flex items-center justify-center group-hover:bg-cyan-500 group-hover:text-black transition-all">
                <RefreshCw size={20} className="group-hover:rotate-180 transition-transform duration-500" />
              </div>
            </div>
          </section>
        </main>

        {/* FOOTER: GLOBAL TELEMETRY BAR */}
        <footer className="flex-none grid grid-cols-2 md:grid-cols-5 gap-6 py-6 px-4 border-t border-white/10 bg-black/40 backdrop-blur-3xl rounded-t-[2rem]">
          {[
            { label: 'Network', val: 'SOLANA_MAINNET', icon: <Globe size={12}/> },
            { label: 'Security', val: 'CEC-CDL_ENCRYPT', icon: <Shield size={12}/> },
            { label: 'Latency', val: '0.012MS', icon: <Activity size={12}/> },
            { label: 'Engine', val: 'CHRONOS_V3', icon: <Cpu size={12}/> },
            { label: 'Asset', val: 'PSI_COIN_SOL', icon: <Layers size={12}/> }
          ].map((m, i) => (
            <div key={i} className="flex flex-col gap-1 border-r border-white/5 last:border-0">
              <span className="text-[9px] text-white/30 uppercase tracking-[0.3em] font-black flex items-center gap-2">
                {m.icon} {m.label}
              </span>
              <span className="text-sm font-mono text-cyan-400 flex items-center gap-2">
                {m.val}
              </span>
            </div>
          ))}
        </footer>
      </div>

      {/* REPORT MODAL */}
      {showReportModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 backdrop-blur-xl bg-black/80 animate-in fade-in">
          <div className="bg-[#0a0a0a] border border-cyan-500/20 rounded-[3rem] w-full max-w-4xl overflow-hidden shadow-[0_0_100px_rgba(34,211,238,0.15)] flex flex-col h-[80vh]">
            <div className="bg-cyan-500 p-8 flex justify-between items-center flex-none">
              <div className="flex items-center gap-4 text-black">
                <FileText size={28} />
                <h2 className="font-black tracking-tighter text-3xl uppercase">✨ CHRONOS_SIGNAL_INTEL</h2>
              </div>
              <button 
                onClick={() => setShowReportModal(false)} 
                className="w-12 h-12 flex items-center justify-center bg-black/10 rounded-full hover:bg-black/20 text-black font-black transition-all"
              >
                ✕
              </button>
            </div>
            <div className="p-12 font-mono text-lg leading-relaxed text-white/90 whitespace-pre-wrap overflow-y-auto flex-1 custom-scrollbar bg-gradient-to-b from-transparent to-white/5">
              {report}
            </div>
            <div className="p-8 border-t border-white/5 bg-white/5 flex justify-end flex-none">
              <button 
                onClick={() => setShowReportModal(false)}
                className="px-12 py-5 bg-white text-black font-black rounded-2xl text-sm uppercase tracking-widest hover:bg-cyan-400 active:scale-95 transition-all shadow-xl"
              >
                CONFIRM_AND_LOG
              </button>
            </div>
          </div>
        </div>
      )}

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(34, 211, 238, 0.3); border-radius: 10px; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow linear infinite; animation-duration: 30s; }
      `}</style>
    </div>
  );
};

export default App;
